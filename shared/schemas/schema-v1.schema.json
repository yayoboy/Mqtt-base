{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mqtt-telemetry.org/schemas/v1.0.0",
  "title": "MQTT Telemetry Schema Definition",
  "description": "Schema for defining MQTT telemetry data structures",
  "type": "object",
  "required": ["name", "version", "fields"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Unique schema name",
      "pattern": "^[a-z0-9_]+$"
    },
    "version": {
      "type": "string",
      "description": "Semantic version",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description"
    },
    "topic_pattern": {
      "type": "string",
      "description": "MQTT topic pattern (supports wildcards + and #)"
    },
    "format": {
      "type": "string",
      "enum": ["json", "msgpack", "protobuf", "avro", "cbor"],
      "default": "json"
    },
    "fields": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/field"
      }
    },
    "computed_fields": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/computed_field"
      }
    },
    "storage": {
      "$ref": "#/definitions/storage_config"
    },
    "validation": {
      "$ref": "#/definitions/validation_config"
    }
  },
  "definitions": {
    "field": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
        },
        "type": {
          "type": "string",
          "enum": [
            "string",
            "integer",
            "float",
            "double",
            "boolean",
            "timestamp",
            "array",
            "object",
            "binary"
          ]
        },
        "required": {
          "type": "boolean",
          "default": false
        },
        "description": {
          "type": "string"
        },
        "unit": {
          "type": "string",
          "description": "Physical unit (e.g., celsius, meter, volt)"
        },
        "default": {
          "description": "Default value if missing"
        },
        "auto_fill": {
          "type": "boolean",
          "description": "Auto-fill with system value (timestamp, device_id)",
          "default": false
        },
        "validation": {
          "type": "object",
          "properties": {
            "min": {
              "type": "number"
            },
            "max": {
              "type": "number"
            },
            "pattern": {
              "type": "string",
              "description": "Regex pattern for string validation"
            },
            "enum": {
              "type": "array",
              "description": "Allowed values"
            },
            "min_length": {
              "type": "integer"
            },
            "max_length": {
              "type": "integer"
            }
          }
        }
      }
    },
    "computed_field": {
      "type": "object",
      "required": ["name", "expression"],
      "properties": {
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["string", "integer", "float", "double", "boolean"]
        },
        "expression": {
          "type": "string",
          "description": "Expression to compute value (supports math and field references)"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "storage_config": {
      "type": "object",
      "properties": {
        "table": {
          "type": "string",
          "description": "Database table name"
        },
        "retention": {
          "type": "string",
          "description": "Data retention period (e.g., 90d, 1y)",
          "pattern": "^\\d+[hdwmy]$"
        },
        "compression": {
          "type": "boolean",
          "default": true
        },
        "index": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Fields to index"
        },
        "aggregations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["interval"],
            "properties": {
              "interval": {
                "type": "string",
                "pattern": "^\\d+[smhd]$"
              },
              "functions": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["avg", "min", "max", "sum", "count", "stddev"]
                }
              }
            }
          }
        }
      }
    },
    "validation_config": {
      "type": "object",
      "properties": {
        "strict": {
          "type": "boolean",
          "description": "Reject messages that don't match schema",
          "default": true
        },
        "allow_extra_fields": {
          "type": "boolean",
          "default": false
        },
        "coerce_types": {
          "type": "boolean",
          "description": "Try to convert types automatically",
          "default": true
        }
      }
    }
  }
}
